#!/bin/sh

# Copyright IBM Corporation All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0

# Pre-commit hook to run checks like trivy scan
# This hook is installed globally via git init.templateDir See Dockerfile

set -e

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

printf "%bGG|PreCommit === Running Pre Commit checks ===%b\n" "${YELLOW}" "${NC}"
__gg_pre_scan_errors=0

printf "%bGG|PreCommit === Running Trivy Security Scan ===%b\n" "${YELLOW}" "${NC}"
# Run Trivy scan, skipping .ssh directories
# --exit-code 1: Exit with code 1 if vulnerabilities/secrets are found
# --severity: Fail on MEDIUM and above for both vulnerabilities and secrets
if trivy --cache-dir /tmp/cache/trivy fs --skip-dirs "**/.git" --exit-code 1 --severity MEDIUM,HIGH,CRITICAL . ; then
  printf "%b✅ Trivy scan passed! Proceeding with commit.%b\n" "${GREEN}" "${NC}"
else
  printf "%b❌ Trivy scan failed!%b\n" "${RED}" "${NC}"
  __gg_pre_scan_errors=$((__gg_pre_scan_errors+1))
fi

## Future / customization: add other checks as needed

## Final interpretation
if [ "$__gg_pre_scan_errors" -gt 0 ]; then
  printf "%b❌ pre-commit checks failed! Correct them before committing. Commit aborted.%b\n" "${RED}" "${NC}"
  printf "%bTo bypass this check (not recommended), use: git commit --no-verify%b\n" "${YELLOW}" "${NC}"
  unset __gg_pre_scan_errors
  exit 1
fi

unset __gg_pre_scan_errors
